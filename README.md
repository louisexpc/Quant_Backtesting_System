# `main.py` 說明

### 檔案功能

`main.py` 是專案的核心執行檔案，負責組織各模組功能，實現回測交易策略的全流程。主要功能包括：

1. 初始化策略和配置。
2. 加載歷史數據。
3. 執行交易策略，生成交易信號並執行交易。
4. 計算最終績效並輸出結果。

---

## 核心類別與方法

### 類別：`backtest`

### 功能描述

`backtest` 類別實現了回測交易的整體邏輯，包括數據加載、交易執行、績效評估等。

---

### 屬性詳解

1. **`data_list`**:
    - 包含交易歷史數據檔案路徑的清單。
    - 例如：`["./data/BTC-USD.csv", "./data/ETH-USD.csv"]`。
2. **`symbols`**:
    - 支援的交易對符號清單。
    - 例如：`["BTCUSD", "ETHUSD"]`。
3. **`account`**:
    - 帳戶物件，用於管理資金和交易歷史 (由 `Account` 類別實現)。
4. **`config`**:
    - 策略配置，由 `ConfigLoader` 載入。
5. **`risk_management`**:
    - 每筆交易的風險管理比率（例如 5%）。
6. **`history`**:
    - 存儲交易歷史的物件（由 `order_history` 類別實現）。

---

### 方法詳解

### `trans_original_data(self) -> dict`

- **功能**: 載入 CSV 格式的歷史數據，並轉換為 pandas DataFrame。
- **輸出**: 一個字典，鍵為交易對符號，值為對應的歷史數據。

### `data_segment(self) -> dict`

- **功能**: 根據當前時間索引，分段提取數據。
- **輸出**: 包含所有交易對的分段數據。

### `calculate_position(self) -> float`

- **功能**: 根據資金和風險比例計算單筆交易的頭寸大小。
- **公式**:
頭寸=失效點帳戶資金×風險比例​
    
    頭寸=帳戶資金×風險比例失效點頭寸 = \frac{\text{帳戶資金} \times \text{風險比例}}{\text{失效點}}
    

### `buy(self, symbol: str)`

- **功能**: 執行買入操作，計算買入數量並更新帳戶與交易歷史。
- **邏輯**:
    - 檢查帳戶資金是否足夠。
    - 計算實際購買數量與手續費。
    - 更新交易歷史。

### `sell(self, order: pd.Series)`

- **功能**: 執行賣出操作，計算賣出收益並更新帳戶與交易歷史。
- **邏輯**:
    - 根據當前價格計算收益。
    - 更新交易歷史和帳戶資金。

### `next(self)`

- **功能**: 在每個時間點執行策略邏輯。
- **邏輯**:
    - 提取當前數據分段。
    - 使用策略生成交易信號。
    - 根據信號執行買入或賣出操作。

### `run(self)`

- **功能**: 遍歷整個數據集，逐步執行回測。
- **邏輯**:
    - 循環執行 `next` 方法。
    - 最後計算持倉價值與總資產，並輸出績效報告。

---

### 使用範例

### `main.py` 主流程

```python

if __name__ == '__main__':
    # 配置參數
    timeframe = '15m'
    ROOT = './data/'
    data_list = [
        ROOT + f"{timeframe}_BTC-USD.csv",
        ROOT + f"{timeframe}_ETH-USD.csv",
    ]
    symbols = ["BTCUSD", "ETHUSD"]

    # 初始化回測物件
    trader = backtest(account_id=0, data_list=data_list, symbols=symbols)

    # 設定帳戶參數
    trader.account.set_asset(1000)  # 初始資金
    trader.account.set_commission(0.001)  # 手續費

    # 執行回測
    trader.run()

```

---

### 執行結果範例

```
plaintext
複製程式碼
Testing Down
Account ID: 0
Final asset: 950.00, position value: 50.00 Total: 1000.00
sharp ratio: 0.85
Profit-Loss Ratio: 1.50
Win Rate: 0.60

```

---

## 邏輯流程圖

```
plaintext
複製程式碼
+-----------------------------+
| 初始化回測環境             |
+-------------+---------------+
              |
              v
+-----------------------------+
| 載入歷史數據               |
+-------------+---------------+
              |
              v
+-----------------------------+
| 初始化策略與帳戶參數       |
+-------------+---------------+
              |
              v
+-----------------------------+
| 遍歷數據集，逐步執行策略   |
| - 分段提取數據             |
| - 生成交易信號             |
| - 執行交易 (買入/賣出)     |
+-------------+---------------+
              |
              v
+-----------------------------+
| 輸出最終資產與績效報告     |
+-----------------------------+

```

---

## 注意事項

1. **歷史數據格式要求**:
    - 歷史數據需包含 `Datetime` 和 `Close` 欄位。
    - 否則無法正確載入或計算技術指標。
2. **策略配置檔**:
    - 配置檔需正確連結至 `stoch_rsi.json`。
    - 確保所需的交易對數據存在於 `data_list`。
3. **交易執行邏輯**:
    - 最小買入金額設定為 5 USDT，低於該金額的交易會被拒絕。
    - 手續費會影響交易數量與資金計算。
4. **風險管理**:
    - 頭寸計算基於 1% 原則，需合理調整 `risk_management` 屬性以適應不同需求。